# BGP-RPKI-IO Traffic Generator
The BGP traffic generator brio_tg can produce BGP-4 traffic [RFC4271](https://datatracker.ietf.org/doc/html/rfc4271)
as well as fully end to end signed BGPsec traffic [RFC8205](https://datatracker.ietf.org/doc/html/rfc8205). 
In addition, brio_tg allows to test BGPsec crypto algorithms as long as they 
implement the SRxCryproAPI interface. This allows to create BGPsec algorithm 
performance tests. 

Furthermore, BRIO's brio_tg allows to receive BGP and BGPsec UPDATES and dump 
them into text files for further processing.

#### What it is not...
It is important to understand that **brio_tg** is only a test tool and does 
**NOT** process and ASPA Objects, ROA Objects, BGPsec Keys or perform any 
validation or routing as it is expected from a BGP router.

#### Requirements
BRIO is tested on **Rocky 9** Linux and **Ubuntu 22** Linux distributions. The
OS can be installed as minimal install, the provided install shell script will
install all required libraries using the **dnf** or **apt** package managers.  

#### Installation
The installation instructions are provided in the main [README](README.md) file.

## Users Guide (brio_tg)
This section explains on how to use the tool, its parameters, as well as a simple
example.

#### Operational Modes
brio_tg allows multiple modes of operation. The following Modes are supported in 
this version:

| Mode  | Description |
| ----- | ----------- |
| BGP   | This mode (Default) generates BGP updates containing the BGPsec path attribute  |
| GEN-x | This mode allows to pre-generate bgpsec signed updates for performance testing. |
| CAPI  | This mode allows to make direct calls into the SRxCryptoAPI for performance tests of SRxCryproAPI plugins. |

The software can be controlled using a configuration file as well as program
parameters. Program parameters always override settings in the configuration 
file. The traffic is generated by passing scripted updates of the following
form either via command line parameters, using pipes, or scripted within the 
configuration file.

#### BRIO updates - Or Creating Topologies:
Topologies are scripted using BRIO updates. A BRIO update consists of a IP 
prefix followed by a path. In case the path is omitted, brio_tg is the prefix
originator.  
By default, BRIO updates are generated as BGPsec UPDATES. To force the generation
of a BGP-4, the tag **B4** must be pre-pended to any path specification.
The right-most ASN is the origin, the ASN of brio_tg will be added automatically. 
To allow sending the Rout Origin Validation (ROA) validation state as community 
string [RFC8097](BGP Prefix Origin Validation State Extended Community) to the 
UPDATE, append either of the settings **I**:invalid, **V**:valid, or **N**:not-found 
to the scripted BRIO update.

**Update Format:**  ```<prefix>[ ]*[,(B4 )?(<asn>[(p|P)?<pCount>] )*(I|V|N)?]```


Example: brio_tg as ASN 65000

| BRIO update                |    | Generated BGP UPDAT                               | 
| :------------------------- | -  | :------------------------------------------------ |
| 10.0.0.0/24                | -> | 65000 65010 (10.0.0.0/24)                         |
| 10.0.1.0/24, 65020 65030   | -> | 65000 65010 65020 65030 (10.0.1.0/24)             |
| 10.0.2.0/24, 65020p3 65030 | -> | 65000 65010 65020 65020 65020 65030 (10.0.2.0/24) |
|                            |    |                                                   |
| 10.0.3.0/24, 65000         | -> | 65000 65000 (10.0.3.0/24)                         |

BGP-4 prefix packing can be enabled for BGP-4 UPDATES only. By default prefix 
packing is disabled. Prefix packing will only be done for prefixes whose updates
are scripted consecutively and have the same AS path. 

Example: brio_tg as ASN 65000
| BRIO update        |    | Generated BGP UPDAT                     | 
| :------------------| -  | :---------------------------------------|
| 10.0.0.0/24  65020 |    |                                         |
| 10.0.1.0/24, 65020 | => | 65000 65020 (10.0.0.0/24, 10.0.1.0/24 ) |

##### Order of loading BRIO updates
BRIO updates can be added in multiple ways such as configuration file, parameter,
stored in pre-generated binary form, via command line and piped through stdio.
The following table shows the order in which updates are generated.

| Order | Type                | Description  |
| :---: | :------------------ | :----------- |
|   1   | Session Updates     | Configured in the session section of the configuration file. |
|   2   | Global Updates      | Configured in the global section of the configuration file.  |
|   3   | Binary File Updates | BRIO updates stored during a previous run. These updates are already converted into BGP/BGPsec UPDATES | 
|   4   | Comand Line Updates | Passed to brio_tg during program call.                       | 
|   5   | Piped Updates       | brio_tg is called and traffic is added using pipes.          |

#### Private and Public Keys:  
Private and public keys are generated using the key generation functions of the
SRxCryptoAPI. Important here is the key-list.txt file. The brio_tg reads this 
file to pre-load all keys for processing. For more info on keys see the 
SRxCryptoAPI.

For all different settings, please call **``brio_tg -?``** or check the 
configuration file.

#### BRIO as traffic sink
It is possible to use ```brio_tg``` as traffic receiver. All BGP / BGPSec traffic 
can be printed out on receive in two forms, simple and regular. The regular form 
follows the Wireshark format where as the simple form presents one PDU per line.

#### BGPsec Traffic
A very powerful feature of brio_tg is the capability to generate multi hop
fully signed BGPsec UPDATES [RFC 8205](https://datatracker.ietf.org/doc/html/rfc8205).
Currently ECDSA is the algorithm of choice. This algorithm is non-deterministic 
which means signatures for the same UPDATE will not be the same. To allow
debugging of BGPsec sessions, brio_tg provides three modes of signature 
generation.
1. **BIO** Which uses the internal ECDSA signature algorithm. This is the default 
   mode.
2. **BIO-K1** Same as BIO except it uses a static k which makes the signature
   generation deterministic. 
3. **BIO-K1** Same as BIO-K1 just with a different K.

For the modes BIO-K1 and BIO-K2 the k was chosen from [RFC6979](https://datatracker.ietf.org/doc/html/rfc6979) Section A.2.5. BIO-K1 uses k for SHA256 and msg=sample.
```k=A6E3C57DD01ABE90086538398355DD4C3B17AA873382B0F24D6129493D8AAD60``` 
and BIO-K2 uses k for SHA256 and msg=test.
```k=D16B6AE827F17175E040871A1C7EC3500192C4C92677336EC2537ACAEE0008E0```

Additionally, brio_tg allows to scrip FAKE key SKIs as well as key signatures.
This allows the testing of BGPsec algorithms for correctness. Am UPDATE with a 
fake SKI or signature should not pass validation.

#### Pre-Scripted Traffic
The GEN mode allows to pre-generate BGP and BGPsec UPDATES. This can be used to 
test the processing speed for peers. brio_tg uses OpenSSL's ECDSA implementation 
which is not the most optimized implementation. It is difficult to test a peers 
processing speed if the traffic generator needs to generate multi-hop fully 
signed UPDATES. The faster solution here is to have the traffic pre-generated
and then just loaded and send to the socket.

#### Algorithm Tester
The CAPI mode allows the testing of the speed of an algorithm implementation. The time
measures are taken from the moment the data is handed to the algorithm to the 
moment the algorithm finished validation.

#### Program Parameters
This software has a large number of parameters. Almost all parameters can be
specified via a configuration file. To generate a sample configuration file
call ```brio_tg -C <filename>``` and brio_tg will generate a sample 
configuration file. This file is typically well-documented.

To retrieve all parameters for the command line as well as scrip, call ```brio_tg -?```.

```
Syntax: brio_tg <parameter> [<parameter>]*

 This program allows receiving updates via pipe stream, one update per line.

 Parameter:
 ===========
  -?, -h, -H, --help
          This screen!
  -V, --version
          Display the version number.
  -f <config>, --config <config>
          config: The configuration file.
  -y <config>, --capi_cfg <config>
          config: An alternative SRxCryptoAPI configuration file.
  -u <prefix, path>, --update <prefix, path>
          prefix: Prefix to be announced.
          path: The list of AS numbers (right most is origin).
                The path can contain pCount values using <asn>p<value>
                  to create p repetitions of asn.
                In case the path contains the value 'I', 'V', or 'N'
                  an extended community string will be added with
                  the RPKI validation state I:invalid, V:valid, or
                  N:not-found (no difference between iBGP or eBGP
                To define BGP-4 only path, start path with B4 for BGP-4!
  -s <filename>, --ski_file <filename>
          Name of the SKI file generated by qsrx-publish
  -l <directory>, --ski_key_loc <directory>
          Specify the location where the keys and certificates are located.
  -m <type>, --mode <type>
          Enable the operational mode:
          type BGP: run BGP player
          type CAPI: run as SRxCryptoAPI tester.
          type GEN-B: Generate the binary data of BGPsec UPDATES.
          type GEN-C: Generate the binary data of BGPsec Path Attributes.
  -a <asn>, --asn <asn>
          Specify the own AS number.
  -i <IPv4>, --bgp_ident <IPv4>
          The BGP identifier of the BGP daemon.
  -t <time>, --hold_timer <time>
          The hold timer in seconds (0 or >=3).
  -A <asn>, --peer_asn <asn>
          The peer as number.
  -I <IPv4>, --peer_ip <IPv4>
          The IP address of the peer.
  -P <port>, --peer_port <port>
          The port number of the peer.
  -M, --no_mpnlri
          DEPRECATED.
          Disable MPNLRI encoding for IPv4 addresses.
          If disabled prefixes are encoded as NLRI only.
  -e, --no_ext_msg_cap
          Disable the usage of messages larger than 4096 bytes.
          This includes the capability exchange.(Default enabled)
  -L, --no_ext_msg_liberal
          Reject extended messages if not properly negotiated.
  --ext_msg_force
          Force sending extended messages regardless if capability
          is negotiated. Allows debugging the peer.
  -d <time>, --disconnect <time>
          The minimum time in seconds the session stays up after
          the last update was sent. The real disconnect time is
          somewhere between <time> and <holdTime> / 3.
          A time of 0 "zero" disables the automatic disconnect.
  -T, --convergence
          Enable BGP convergence statistics to be displayed for
          updates received.
  -E, --no_preload_eckey
          Disable pre-computation of EC_KEY structure during
          loading of the private and public keys.
  -b <filename>, --bin <filename>
          The filename containing the binary input data. Here 
          only the first configured session will be used.
  -o <filename>, --out <filename>
          The filename where to write the output to - Here only
          the first configured session will be used.
          Requires GEN mode!!
  -O, --appendOut
          If specified, the generated data will be appended to
          given outfile. In case the outfile does not exist, a
          new one will be generated.
          Requires GEN mode!!
  -U, --max
          Allows to restrict the number of updates generated.
  -C <filename>
          Generate a configuration file. The configuration file
          uses the given setup (parameters, configuration file)
          or generates a sample file if no configuration is
          specified.
  -n <interface>
          Use the interface to determine the local IP address.
          This setting is only used in combination with the
          creation of a configuration file.
  --suppress-warning
          This setting disables the programs WARNING message
          this software is for test purpose only.
  --show-settings
          Display the configured settings and stop application.
  --disable_bgpsec
          Disable BGPsec processing and generate all updates as
          BGP 4 updates only. This only works in 'BGP' mode.

 Configuration file only parameters:
 ===================================
  incl_global_updates
          Enable/Disable adding global updates to this session.
          Default: true
  cap_as4
          Enable/Disable the usage of 4 byte ASN.
          Default: true (enable)
  bgpsec_v4_rcv
          Specify if bgpsec-io can receive IPv4 BGPSEC traffic.
          Default: true
  bgpsec_v4_snd
          Specify if bgpsec-io can send IPv4 BGPSEC traffic.
          Default: true
  bgpsec_v6_rcv
          Specify if bgpsec-io can receive IPv6 BGPSEC traffic.
          Default: true
  bgpsec_v6_snd
          Specify if bgpsec-io can send IPv6 BGPSEC traffic.
          Default: false
  local_addr
          Specify the IP address used for this session. In case
          no local IP is specified the BGP identifier is
          used.
  signature_generation
          Specify the signature generation mode:
          mode CAPI: Use CAPI to sign the updates.
          mode BIO: Use internal signature algorithm (default).
          mode BIO-K1: Same as BIO except it uses a static k.
          mode BIO-K2: Same as BIO except it uses a static k.
          The signature modes BIO-K1 and BIO-K2 both use a k 
          which is specified in RFC6979 Section A.2.5
          BIO-K1 uses k for SHA256 and msg=sample.
           k=A6E3C57DD01ABE90086538398355DD4C3B17AA873382B0F24D6129493D8AAD60
          BIO-K2 uses k for SHA256 and msg=test.
           k=D16B6AE827F17175E040871A1C7EC3500192C4C92677336EC2537ACAEE0008E0
  only_extended_length
          Force usage of extended length also for BGPSEC
          path attributes with a length of less than 255 bytes.
  null_signature_mode
          Specify what to do in case no signature can be
          generated. Example: no key information is found.
          Valid values are (DROP|FAKE|BGP4).
  fake_signature
          This string contains the fake signature in hex format.
          The signature must not be longer than 255 bytes.
          (2 HEX characters equals one byte!).
  fake_ski
          This string contains the fake ski for not found keys.
          The SKI MUST consist of 20 bytes.
          (2 HEX characters equals one byte!).

  printOnSend, printOnReceive
          Each BGP update packet sen/received will be printed on
          standard output in WireShark form.
          Use this setting for debug only!!
          Both settings can be used in two different forms:
          (1) Set =true|false to this for all message types.
          (2) Use as sub configuration to fine-tune each message.
              Using this form sets all message types to false and
              they must be individually set to true.
              = { msg-type = true|false; ... }; 
              Valid message types are:
              open
                      Printing of bgp OPEN messages.
              update
                      Printing of bgp UPDATE messages.
              keepalive
                      Printing of bgp KEEPALIVE messages.
              notification
                      Printing of bgp NOTIFICATION messages.
              unknown
                      Printing of future bgp messages.
  printSimple
          Print BGP messages in simple format (true) or in
          Wireshark format (fasle).
  printPollLoop
          Print information each time the poll loop runs.
  printOnInvalid
          Print status information on validation result invalid.
          This setting only affects the CAPI mode.

NIST-SRx brio_tg Version b0.7.0.1

Developed 2015-2025 by Oliver Borchert - NIST
Send bug reports to itrg-contact@list.nist.gov
```

#### Configuration File

```
#BGPRPKI-IO Configuration file. Auto generated by brio_tg Vb0.7.0.1

ski_file    = "/opt/brio-examples/bgpsec-keys/ski-list.txt";
ski_key_loc = "/opt/brio-examples/bgpsec-keys/";

preload_eckey = false;

# Choose from the following types "BGP", "CAPI", "GEN-B", and "GEN-C"
mode = "BGP";
# Maximum combined number of updates to process. Script 0 for MAX INT
max = 0;

# Allow to force the usage of the flag for extended length being set. 
only_extended_length = true;

# bin = "<binary input file>";
# out = "<binary output file>";
# Append data to the out file.
appendOut = "false";

# Allow to specify a configuration file for srx-crypto-api,If this is not specified,
# the default srx-crypto-api configuration (determined by the API) will be used.
#capi_cfg = "<configuration file>";

# Multiple sessions possible (at a later time)
session = (
  {
    asn        = 65000;
    bgp_ident  = "10.0.1.64";
    hold_timer = 180;

    # Allows to specify specific session IP.
    # If not specified, the bgp_ident value is used!
    #local_addr = "10.0.1.64";

    # Allows to specify next hop address. If not,
    # specified the bgp identifier is used instead!
    #next_hop_ipv4 = "10.0.1.64";
    # Required for sending IPv6 updates.
    #next_hop_ipv6 = "0:0:0:0:0:ffff:a00:140";

    peer_asn   = 65005;
    peer_ip    = "10.0.1.32";
    peer_port  = 179;

    # Run forever or until the peer shuts down.
    disconnect = 0;

    # Enable BGP convergence measurement framework.
    convergence = false;

    # Allow to enable/disable extended message capability.
    ext_msg_cap = true;
    # Allow to enable/disable liberal behavior when 
    # receiving extended message capability.
    ext_msg_liberal = true;
    # Overwrite draft / RFC specification and force.
    # sending extended message regardless if negotiated or not.
    #ext_msg_force = true;

    # Configure BGP capabilities.
    #cap_as4 = true;

    # Configure BGPSEC capabilities.
    bgpsec_v4_snd = true;
    bgpsec_v4_rcv = true;
    bgpsec_v6_snd = true;
    bgpsec_v6_rcv = true;

    # Updates for this session only
    # (path prefix B4 specifies BGP-4 only update!)
    # <prefix>[,[B4]? ([{]?<asn>[p<repitition>][ ]*[}]?)+[I|V|N]?]
    #   <asn>        := [0-9]+[.[0-9]+]?>
    #   <repetition> := [0-9]+
    # Updates are allowed to have one AS_SET { 65010 65020 } in the path
    update = (  "10.0.0.0/24"
              , "10.1.0.0/24, B4 65010 65015p3 65020"
              , "10.0.1.0/24, 65010 65015p3 65020"
              , "10.0.2.0/24, 65010 65015 65025 65030"
              , "10.0.3.0/24, 65010 65015 65536 65040V"
             );

    # Enable/Disable adding global updates to this session.
    incl_global_updates = true;

    # Allow prefix packing for BGP-4 scripted updates
    # where ever possible.
    prefixPacking = false;

    algo_id = 1;

    # Choose from the following signature modes (CAPI|BIO|BIO-K1|BIO-K2)
    signature_generation = "BIO";

    #In case the signature generation does fail, the
    #following settings are possible (DROP| FAKE| BGP4)
    null_signature_mode = "FAKE";
    fake_signature      = "1BADBEEFDEADFEED" "2BADBEEFDEADFEED"
                          "3BADBEEFDEADFEED" "4BADBEEFDEADFEED"
                          "5BADBEEFDEADFEED" "6BADBEEFDEADFEED"
                          "7BADBEEFDEADFEED" "8BADBEEFDEADFEED"
                          "ABADBEEFFACE";
    fake_ski            = "0102030405060708" "090A0B0C0D0E0F10"
                          "11121314";

    # Allow printout of send and received BGP/BGPsec traffic.
    printOnSend    = false;
    # Or more detailed as a filter
    #printOnSend = {
    #  open         = true;
    #  update       = true;
    #  keepalive    = true;
    #  notification = true;
    #  unknown      = true;
    #};

    printOnReceive    = false;
    # Or more detailed as a filter
    #printOnReceive = {
    #  open         = true;
    #  update       = true;
    #  keepalive    = true;
    #  notification = true;
    #  unknown      = true;
    #};

    #printSimple     = false;

    printPollLoop  = false;

    # For CAPI Mode.
    printOnInvalid = false;

  }
# Currently multi sessions are not supported, that is
# the reason the following section is commented out!
#  ,{
      # Here script another session
      # Minimum configuration
      # asn = 65000;
      # bgp_ident = 10.0.1.64;
      # peer_asn = 65005;
      # peer_ip = 10.0.1.32;
#  }

);

# global updates for all sessions
# <prefix>[,[B4]? ([{]?<asn>[p<repitition>][ ]*[}]?)+[I|V|N]?]
#   <asn>        := [0-9]+[.[0-9]+]?>
#   <repitition> := [0-9]+
# Updates are allowed to have one AS_SET { 65010 65020 } in the path
update = ( 
         );
```

---
[Back](README.md)